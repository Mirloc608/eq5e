<section class="eq5e-sheet eq5e-sheet--parchment" style="--eq5e-parchment: url('{{eq5e.ui.parchment}}');">
  <style>
    .eq5e-sheet--parchment { background-image: var(--eq5e-parchment); background-size: cover; background-position: center; padding: 12px 14px; color: rgba(20, 15, 10, 0.95); }
    .eq5e-sheet input, .eq5e-sheet select, .eq5e-sheet textarea { color: rgba(20, 15, 10, 0.95); }
    .eq5e-muted { opacity: .8; }
    .eq5e-header { display: grid; grid-template-columns: 124px 1fr 260px; gap: 12px; align-items: center; margin-bottom: 10px; }
    .eq5e-portrait-wrap { position: relative; width: 124px; height: 124px; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,0.25); border: 1px solid rgba(60,40,20,0.35); background: rgba(255,255,255,0.15); }
    .eq5e-portrait { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
    .eq5e-crest { position: absolute; right: -10px; bottom: -10px; width: 74px; height: 74px; opacity: .92; filter: drop-shadow(0 6px 10px rgba(0,0,0,.35)); pointer-events: none; }
    .eq5e-nameblock input[name="name"]{ font-size: 24px; font-weight: 800; letter-spacing: .3px; border: none; background: rgba(255,255,255,0.22); padding: 6px 10px; border-radius: 10px; width: 100%; }
    .eq5e-subgrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
    .eq5e-pill { background: rgba(255,255,255,0.18); border: 1px solid rgba(60,40,20,0.22); border-radius: 10px; padding: 6px 8px; line-height: 1.1; box-shadow: inset 0 1px 0 rgba(255,255,255,0.25); }
    .eq5e-pill .label { font-size: 11px; opacity: .85; text-transform: uppercase; }
    .eq5e-pill .value { font-size: 14px; font-weight: 700; }
    .eq5e-vitals { display:grid; grid-template-columns: repeat(4, 1fr); gap: 8px; justify-self: end; }
    .eq5e-vitals .eq5e-pill { text-align:center; }
    .eq5e-vitals .value { font-size: 18px; }

    nav.eq5e-tabs { display:flex; gap: 8px; padding: 6px; border-radius: 12px; background: rgba(40,25,10,0.18); border: 1px solid rgba(60,40,20,0.25); margin-bottom: 10px; flex-wrap: wrap; }
    nav.eq5e-tabs a.item { padding: 6px 10px; border-radius: 10px; font-weight: 800; letter-spacing: .2px; text-transform: uppercase; font-size: 12px; opacity: .92; border: 1px solid transparent; cursor: pointer; user-select: none; }
    nav.eq5e-tabs a.item.active { background: rgba(255,255,255,0.22); border-color: rgba(60,40,20,0.28); box-shadow: inset 0 1px 0 rgba(255,255,255,0.3); }

    .eq5e-body { display:grid; grid-template-columns: 300px 1fr; gap: 12px; }
    .eq5e-card { background: rgba(255,255,255,0.16); border: 1px solid rgba(60,40,20,0.22); border-radius: 14px; padding: 10px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.25); }
    .eq5e-card h3{ margin: 0 0 8px 0; font-size: 12px; letter-spacing: .3px; text-transform: uppercase; border-bottom: 1px solid rgba(60,40,20,0.18); padding-bottom: 6px; }
    .eq5e-abilities { display:grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .eq5e-ability { text-align:center; border-radius: 12px; padding: 8px 6px; border: 1px solid rgba(60,40,20,0.2); background: rgba(255,255,255,0.12); }
    .eq5e-ability .abbr { font-weight: 900; font-size: 12px; }
    .eq5e-ability .score { font-size: 18px; font-weight: 900; margin-top: 2px; }
    .eq5e-ability .mod { font-size: 12px; opacity: .85; }
    .eq5e-mini-btn { border-radius: 10px; border: 1px solid rgba(60,40,20,0.25); background: rgba(255,255,255,0.18); padding: 2px 8px; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; }
    .eq5e-skills .row { display:grid; grid-template-columns: 18px 1fr 40px 46px; gap: 8px; align-items:center; padding: 4px 0; border-bottom: 1px dashed rgba(60,40,20,0.15); }
    .eq5e-dot { width: 10px; height: 10px; border-radius: 999px; border: 1px solid rgba(60,40,20,0.3); background: rgba(255,255,255,0.15); justify-self: center; }
    .eq5e-dot.on { background: rgba(120,30,30,0.35); }

    .tab[data-group="sheet"]{ display:none; }
    .tab[data-group="sheet"].active{ display:block; }

    .eq5e-inv-row { display:grid; grid-template-columns: 60px 1fr 90px 90px; gap: 8px; align-items:center; padding: 6px 0; border-bottom: 1px dashed rgba(60,40,20,0.15); }
    .eq5e-slot { font-size: 11px; opacity: .85; text-align:right; }

    .eq5e-paperdoll { display:grid; grid-template-columns: 1fr 180px 1fr; gap: 12px; align-items: start; }
    .eq5e-doll-silhouette { height: 420px; border-radius: 16px; border: 1px solid rgba(60,40,20,0.22); background: rgba(255,255,255,0.12); display:flex; align-items:center; justify-content:center; font-weight: 900; opacity: .7; text-align:center; padding: 10px; }
    .eq5e-slotbox { border-radius: 12px; border: 1px solid rgba(60,40,20,0.22); background: rgba(255,255,255,0.14); padding: 8px; margin-bottom: 8px; outline: 1px dashed rgba(60,40,20,0.25); }
    .eq5e-slotbox:hover { filter: brightness(1.06); }
    .eq5e-slotbox .slotlabel { font-size: 11px; text-transform: uppercase; opacity: .85; font-weight: 900; display:flex; justify-content:space-between; align-items:center; gap: 8px; }
    .eq5e-slotbox .slotitem { font-weight: 900; margin-top: 4px; display:flex; justify-content:space-between; gap: 8px; }
    .eq5e-slotbox .slotitem .empty { opacity: .7; font-weight: 700; }
    .eq5e-xbtn { border-radius: 10px; border: 1px solid rgba(60,40,20,0.25); background: rgba(255,255,255,0.18); padding: 0 8px; font-size: 12px; font-weight: 900; cursor: pointer; line-height: 18px; height: 20px; }
    .eq5e-clear-token { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(60,40,20,0.25); background: rgba(255,255,255,0.18); font-weight: 900; text-transform: uppercase; font-size: 11px; cursor: grab; }
  </style>

  <header class="eq5e-header">
    <div class="eq5e-portrait-wrap">
      <img class="eq5e-portrait" src="{{actor.img}}" alt="{{actor.name}}" data-action="editImage" data-field="img"/>
      <img class="eq5e-crest" src="{{eq5e.ui.crest}}" alt="Class Crest"/>
    </div>

    <div class="eq5e-nameblock">
      <input type="text" name="name" value="{{actor.name}}" placeholder="Name"/>
      <div class="eq5e-subgrid">
        <div class="eq5e-pill"><div class="label">Class</div><div class="value">{{eq5e.sheet.className}}</div></div>
        <div class="eq5e-pill"><div class="label">Race</div><div class="value">{{system.details.race}}</div></div>
        <div class="eq5e-pill"><div class="label">Level</div><div class="value">{{system.details.level}}</div></div>
      </div>
    </div>

    <div class="eq5e-vitals">
      <div class="eq5e-pill"><div class="label">AC</div><div class="value">{{eq5e.sheet.vitals.ac.value}}</div></div>
      <div class="eq5e-pill"><div class="label">Init</div><div class="value">{{eq5e.sheet.vitals.init.value}}</div></div>
      <div class="eq5e-pill"><div class="label">Speed</div><div class="value">{{eq5e.sheet.vitals.speed.value}}</div></div>
      <div class="eq5e-pill"><div class="label">HP</div><div class="value">{{eq5e.sheet.vitals.hp.value}} / {{eq5e.sheet.vitals.hp.max}}</div></div>
    </div>
  </header>

  <nav class="eq5e-tabs" data-group="sheet">
    <a class="item active" data-tab="character" data-group="sheet">Character</a>
    <a class="item" data-tab="inventory" data-group="sheet">Inventory</a>
    <a class="item" data-tab="paperdoll" data-group="sheet">Paper Doll</a>
    <a class="item" data-tab="spells" data-group="sheet">Spells</a>
    <a class="item" data-tab="aas" data-group="sheet">AAs</a>
    <a class="item" data-tab="bio" data-group="sheet">Bio</a>
  </nav>

  <section class="eq5e-body">
    <section class="eq5e-card">
      <h3>Abilities</h3>
      <div class="eq5e-abilities">
        {{#each eq5e.sheet.abilities as |a|}}
          <div class="eq5e-ability">
            <div class="abbr">{{a.label}}</div>
            <div class="score">{{a.value}}</div>
            <div class="mod">MOD {{a.mod}} • SAVE {{a.save}}</div>
            <div style="margin-top:6px; display:flex; justify-content:center; gap:6px;">
              <button type="button" class="eq5e-mini-btn" data-action="rollAbility" data-ability="{{a.key}}">Roll</button>
              <button type="button" class="eq5e-mini-btn" data-action="rollSave" data-ability="{{a.key}}">Save</button>
            </div>
          </div>
        {{/each}}
      </div>

      <div style="height:10px;"></div>

      <h3>Skills</h3>
      <div class="eq5e-skills">
        {{#each eq5e.sheet.skills as |s|}}
          <div class="row">
            <span class="eq5e-dot {{#if s.proficient}}on{{/if}}"></span>
            <span style="font-weight:700;">{{s.label}}</span>
            <span style="font-weight:900; text-align:right;">{{s.total}}</span>
            <span style="text-align:right;"><button type="button" class="eq5e-mini-btn" data-action="rollSkill" data-skill="{{s.key}}">Roll</button></span>
          </div>
        {{/each}}
      </div>
    </section>

    <section>
      <section class="tab active eq5e-card" data-tab="character" data-group="sheet">
        <h3>Features</h3>
        {{#if eq5e.items.features.length}}
          <ul>
            {{#each eq5e.items.features as |it|}}<li><strong>{{it.name}}</strong></li>{{/each}}
          </ul>
        {{else}}<div class="eq5e-muted">No features yet.</div>{{/if}}

        <h3>Feats</h3>
        {{#if eq5e.items.feats.length}}
          <ul>
            {{#each eq5e.items.feats as |it|}}<li><strong>{{it.name}}</strong></li>{{/each}}
          </ul>
        {{else}}<div class="eq5e-muted">No feats yet.</div>{{/if}}
      </section>

      <section class="tab eq5e-card" data-tab="inventory" data-group="sheet">
        <h3>Inventory</h3>
        <div class="eq5e-muted" style="margin-bottom:8px;">
          Tip: drag an item onto a Paper Doll slot to equip it.
          <button type="button" class="eq5e-mini-btn" data-action="focusTab" data-tab="paperdoll" style="margin-left:8px;">Paper Doll</button>
        </div>

        {{#if eq5e.items.inventory.length}}
          {{#each eq5e.items.inventory as |it|}}
            <div class="eq5e-inv-row">
              <button type="button" class="eq5e-mini-btn" data-action="toggleEquip" data-item-id="{{it._id}}">{{#if it.eq5eEquipped}}On{{else}}Off{{/if}}</button>
              <div><div style="font-weight:900;">{{it.name}}</div><div class="eq5e-muted" style="font-size:11px;">{{it.type}}</div></div>
              <div class="eq5e-slot">{{#if it.eq5eSlot}}{{it.eq5eSlot}}{{else}}—{{/if}}</div>
              <div style="text-align:right; font-weight:900; font-size:11px;">{{#if it.eq5eEquipped}}EQUIPPED{{else}}—{{/if}}</div>
            </div>
          {{/each}}
        {{else}}<div class="eq5e-muted">No inventory items yet.</div>{{/if}}
      </section>

      <section class="tab eq5e-card" data-tab="paperdoll" data-group="sheet">
        <h3>Paper Doll</h3>
        <div class="eq5e-muted" style="margin-bottom:8px;">
          Drop items onto slots to equip. Occupied slots swap. Slot rules are enforced.
        </div>

        <div class="eq5e-clear-token" draggable="true"
             ondragstart="event.dataTransfer.setData('text/plain', JSON.stringify({eq5e:'clear-slot'}));">
          <i class="fa-solid fa-eraser"></i> Empty (Drag to Clear)
        </div>

        <div style="height:10px;"></div>

        <div class="eq5e-paperdoll">
          <div>
            {{#each eq5e.paperdoll.slots as |s|}}
              {{#if (or (eq s.key "head") (eq s.key "face") (eq s.key "neck") (eq s.key "shoulders") (eq s.key "arms") (eq s.key "wrists") (eq s.key "hands") (eq s.key "ear1") (eq s.key "ear2") )}}
                <div class="eq5e-slotbox" data-eq5e-drop-slot="1" data-slot="{{s.key}}" title="Allowed: {{s.allowed}}">
                  <div class="slotlabel">
                    <span>{{s.label}}</span>
                    <span style="display:flex; gap:6px; align-items:center;">
                      <span class="eq5e-muted">{{s.allowed}}</span>
                      <button type="button" class="eq5e-xbtn" data-action="unequipSlot" data-slot="{{s.key}}" title="Unequip / Clear">×</button>
                    </span>
                  </div>
                  <div class="slotitem">
                    {{#if s.item}}<span>{{s.item.name}}</span>{{else}}<span class="empty">Empty</span>{{/if}}
                    <span class="eq5e-muted">{{#if s.item}}{{s.item.type}}{{else}}—{{/if}}</span>
                  </div>
                </div>
              {{/if}}
            {{/each}}
          </div>

          <div class="eq5e-doll-silhouette">
            EverQuest<br/>Paper Doll<br/><span class="eq5e-muted" style="font-size:12px; font-weight:800;">Drop gear on slots</span>
          </div>

          <div>
            {{#each eq5e.paperdoll.slots as |s|}}
              {{#if (or (eq s.key "chest") (eq s.key "back") (eq s.key "waist") (eq s.key "legs") (eq s.key "feet") (eq s.key "ring1") (eq s.key "ring2") (eq s.key "primary") (eq s.key "secondary") (eq s.key "range") (eq s.key "ammo") )}}
                <div class="eq5e-slotbox" data-eq5e-drop-slot="1" data-slot="{{s.key}}" title="Allowed: {{s.allowed}}">
                  <div class="slotlabel">
                    <span>{{s.label}}</span>
                    <span style="display:flex; gap:6px; align-items:center;">
                      <span class="eq5e-muted">{{s.allowed}}</span>
                      <button type="button" class="eq5e-xbtn" data-action="unequipSlot" data-slot="{{s.key}}" title="Unequip / Clear">×</button>
                    </span>
                  </div>
                  <div class="slotitem">
                    {{#if s.item}}<span>{{s.item.name}}</span>{{else}}<span class="empty">Empty</span>{{/if}}
                    <span class="eq5e-muted">{{#if s.item}}{{s.item.type}}{{else}}—{{/if}}</span>
                  </div>
                </div>
              {{/if}}
            {{/each}}
          </div>
        </div>
      </section>

      <section class="tab eq5e-card" data-tab="spells" data-group="sheet">
        <h3>Spells</h3>
        {{#if eq5e.items.spells.length}}<ul>{{#each eq5e.items.spells as |it|}}<li><strong>{{it.name}}</strong></li>{{/each}}</ul>{{else}}<div class="eq5e-muted">No spells yet.</div>{{/if}}
      </section>

      <section class="tab eq5e-card" data-tab="aas" data-group="sheet">
        <h3>Alternate Abilities</h3>
        {{#if eq5e.items.aas.length}}<ul>{{#each eq5e.items.aas as |it|}}<li><strong>{{it.name}}</strong></li>{{/each}}</ul>{{else}}<div class="eq5e-muted">No AAs yet.</div>{{/if}}
      </section>

      <section class="tab eq5e-card" data-tab="bio" data-group="sheet">
        <h3>Bio</h3>
        <textarea name="system.details.biography" rows="12" style="width:100%; background: rgba(255,255,255,0.18); border:1px solid rgba(60,40,20,0.22); border-radius: 10px; padding: 8px;">{{system.details.biography}}</textarea>
      </section>
    </section>
  </section>
</section>
